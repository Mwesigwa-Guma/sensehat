By: C. Erastus Toe 
******PREREQUISITES TO INSTALL THE PYTHON LIBRARY sense-hat*****
Upgrade pip
Pip3 install --upgrade pip
Install python headers 
dnf install python3-devel 
Problems with pip3
If you’re having problems installing pip3, do the following.
Uninstall pip3: python3 -m pip uninstall 
Reinstall pip3: dnf reinstall python3-pip
Install gcc and c++:
dnf install gcc  
dnf install gcc-c++

************ Installing Pillow  ***********
Install zlib
dnf install zlib-devel 
Install jpeg
dnf install libjpeg-devel
Also this too:
dnf install python3-devel redhat-rpm-config 
Install pillow
pip3 install pillow 

*************** Install Numpy *****************
Upgrade setup tools
pip3 install -U setuptools
Upgrade wheel 
pip3 install -U wheel 
Install lapack
dnf  install lapack-devel 
Might need to install python36:
dnf install python36
Reboot system
Systemctl reboot
Install numpy       
pip3 install numpy 
Collecting numpy
  Using cached https://files.pythonhosted.org/packages/b6/d6/be8f975f5322336f62371c9abeb936d592c98c047ad63035f1b38ae08efe/numpy-1.17.3.zip
Building wheels for collected packages: numpy
  Building wheel for numpy (setup.py) ... \^[[done
  Stored in directory: /root/.cache/pip/wheels/5e/e9/4b/dd5a8eb53e97dfcc1314eca9c6769edd3cad379d6644c1ad94
Successfully built numpy
Installing collected packages: numpy
Successfully installed numpy-1.17.3



************* Install sense-hat ************
Sense HAT repo 
pip3 install sense-hat
Collecting sense-hat
  Using cached https://files.pythonhosted.org/packages/13/cd/f30b6709e01cacd0f9e2882ce3c0633ea2862771a75f4a9d02a56db9ec9a/sense_hat-2.2.0-py2.py3-none-any.whl
Requirement already satisfied: pillow in /usr/local/lib64/python3.7/site-packages (from sense-hat) (6.2.1)
Requirement already satisfied: numpy in /usr/local/lib64/python3.7/site-packages (from sense-hat) (1.17.3)
Installing collected packages: sense-hat
Successfully installed sense-hat-2.2.0

When testing sense hat, you’ll run into a problem involving RTIMULib. Below are the steps to fix it. 

	Note: RTIMULib is used to connect Inertial measurement unit such as the 4 sensors of sense-hat to raspberry pi in order to obtain data from them. In order words RTIMULib is used to get data from the sensors: 
	Read more about RTIMULIb here. And about IMU here

************ FIX THE RTIMULIB PROBLEM *********

Github site for the repo is here

git clone https://github.com/RPi-Distro/RTIMULib
cd ./RTIMULib/Linux/python/
python3 setup.py install
rm -rf ~/RTIMULib 

***CHECK to see if sensehat & sensors are addressable in I2C bus 
Install i2c tools
Dnf install i2c_tools
	Use Command: ‘i2cdetect -y 1’

	0x46 represents the address of the LED Matrix 
	0x1c represents the address of the Accelerometer sensor
0x6a represents the address of the Magnetometer sensor
0x5c represents the address of Pressure/Temperature sensors
0x5f represents the address of Humidity/Temperature sensor

Read more about the addresses here 

**** CHECK to see if there’s an overlay of sense hat ***** 
	ls/boot/efi/overlays. There should be a file called rpi-sense.dbto

	NOTE: if you try the hello world example for sense hat, you should encounter this error:

File "/usr/local/lib/python3.7/site-packages/sense_hat/sense_hat.py", line 39, in __init__
raise OSError('Cannot detect %s device' % self.SENSE_HAT_FB_NAME)
OSError: Cannot detect RPi-Sense FB device

******** WHAT IS A DEVICE TREE *******
A device tree is a data structure describing the hardware components of a particular computer so that the operating system kernel can use and manage those components, including the CPU, the memory, the buses and the peripherals. A device tree consisting of nodes.

Read more about device tree here. The oficial device tree  website 

****** Decompiling and Recompiling Device Tree **********
Navigate to the Device Tree folder
cd /boot/dtb/broadcom/
Decompile the device tree from device tree blob (.dtb) to device tree source (.dts). 
dtc -I dtb -O dts bcm2837-rpi-3-b.dtb > dtb bcm2837-rpi-3-b.dts
Make your changes in the .dts file.
Recompile the device tree from device tree source (.dts) to device tree blob (.dtb)
dtc -I dts -O dtb bcm2837-rpi-3-b.dts > bcm2837-rpi-3-b.dtb
	****** Decompilation syntax *******
dtc -I dtb -O dts bcm2837-rpi-3-b.dtb > dtb bcm2837-rpi-3-b.dts

****** Recompilation syntax *******
dtc -I dts -O dtb bcm2837-rpi-3-b.dts > bcm2837-rpi-3-b.dtb

# add this to the device tree  
		fb {
			compatible = "brcm,bcm2708-fb";
			firmware = <0x7>;
			status = "okay";
			phandle = <0x73>;
		};

Modify i2c in the Device Tree by adding sense hat to it
cd /boot/dtb/broadcom/
dtc -I dtb -O dts bcm2837-rpi-3-b.dtb > dtb bcm2837-rpi-3-b.dts
Make modifications to ‘i2c@7e804000’ by adding a child nodes:
	rpi-sense@46{
		compatible = “rpi,rpi-sense”; 
		reg = < 0x46>;
		keys-int-gpios = < 0x10 0x17 0x1 >;
		status = “okay”;
	};

	lsm9ds1-accel@1c{
		compatible = “st,lsm9ds1-accel”;
		reg = < 0x1c >; 
		status = “okay”;
	};

	hts221-humid@5f{
		compatible = “st,hts221-humid”;
		reg = < 0x5f >; 
		status = “okay”;
	};

	lps25h-press@5c{
		compatible = “st,lps25h-press”;
		reg = < 0x5c >; 
		status = “okay”;
	};

	lsm9ds1-magn@6a{
		compatible = “st,lsm9ds1-magn”;
		status = “okay”;
		reg = < 0x6a >;
	};

Add a root node in the device tree describing Sense Hat 
Hat{
	vendor = “Raspberry Pi”
	product = “Sense Hat”
	uuid = “ee9f595b-5437-4736-9399-94b4cd2a8896”;
	product_ver = “0x0001”
	product_id = “0x0001”
};
After the above steps, make sure to recompile the Device tree and reboot the system. 

************ THE DRIVER PROBLEM **********
Clone the sensehat firmware and driver
https://github.com/raspberrypi/rpi-sense

<preq>
	PACKAGES FOR EMBEDDED DEVELOPMENT 
dnf install avr-gcc avr-lib
<preq>
	Build avrdude from source
	Clone https://github.com/sigmike/avrdude.git
	<preq> 
dnf install automake
dnf install bison -y
dnf install byacc -y
dnf install flex 
	Go into /avrdude/avrdude and run:
		./configure && make && make install

******** ENABLING SPI ****************
Create a file in /etc/modules-load.d/ and add these two modules 
	‘
	spidev 
	spi_bcm2835
	‘
Decompile device tree and make changes 
cd boot/dtb/broadcom/
dtc -I dtb -O dts bcm2837-rpi-3-b.dtb > dtb bcm2837-rpi-3-b.dts
Make these changes to ‘spi@7e20400’:
spi@7e204000 {
			reg = <0x7e204000 0x1000>;
			dmas = <0x7 0x6 0x7 0x7>;
			interrupts = <0x2 0x16>;
			pinctrl-0 = <0xb 0xc>;
			compatible = "brcm,bcm2835-spi";
			cs-gpios = <0xa 0x8 0x1 0xa 0x7 0x1>;
			clocks = <0x6>;
			status = "okay";
			#address-cells = <0x1>;
			phandle = <0x1e>;
			#size-cells = <0x0>;
			dma-names = "tx", "rx";
			pinctrl-names = "default";
			linux,phandle = <0x1e>;

			spidev@0 {
				reg = <0x0>;
				compatible = "spidev";
				spi-max-frequency = <0x7a120>;
				#address-cells = <0x1>;
				#size-cells = <0x0>;
			};

			spidev@1 {
				reg = <0x1>;
				compatible = "spidev";
				spi-max-frequency = <0x7a120>;
				#address-cells = <0x1>;
				#size-cells = <0x0>;
			};
		};
Recompile the device 
dtc -I dts -O dtb bcm2837-rpi-3-b.dts > bcm2837-rpi-3-b.dtb

Reboot the system: 
	systemctl reboot
Run ‘ ls -la /dev/spidev* ‘
crw-------. 1 root root 153, 0 Apr 12  2019 /dev/spidev0.0
crw-------. 1 root root 153, 1 Apr 12  2019 /dev/spidev0.1

	*** PROBLEM RESOLVED ****
******* TESTING SPI ***********
DANIEL COULD YOU PLEASE TEST SPI? 
		https://fedoraproject.org/wiki/Packages_For_Embedded_Development#Atmel_AVR

New SPI Nodes for RPi 4

	spi@7e204000 {
			compatible = "brcm,bcm2835-spi";
			reg = < 0x7e204000 0x200 >;
			interrupts = < 0x00 0x76 0x04 >;
			clocks = < 0x07 0x14 >;
			#address-cells = < 0x01 >;
			#size-cells = < 0x00 >;
			status = "disabled";
			dmas = < 0x0b 0x06 0x0b 0x07 >;
			dma-names = "tx\0rx";
			pinctrl-names = "default";
			pinctrl-0 = < 0x0d 0x0e >;
			cs-gpios = < 0x0f 0x08 0x01 0x0f 0x07 0x01 >;
			phandle = < 0x33 >;

			spidev@0 {
				compatible = "spidev";
				reg = < 0x00 >;
				#address-cells = < 0x01 >;
				#size-cells = < 0x00 >;
				spi-max-frequency = < 0x7735940 >;
				phandle = < 0xa9 >;
			};

			spidev@1 {
				compatible = "spidev";
				reg = < 0x01 >;
				#address-cells = < 0x01 >;
				#size-cells = < 0x00 >;
				spi-max-frequency = < 0x7735940 >;
				phandle = < 0xaa >;
			};
		};

To make patch:
diff -up file1 file2

To apply patch
patch <file> <patchfile>



